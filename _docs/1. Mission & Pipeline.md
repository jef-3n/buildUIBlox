# **Design Guidance: 1\. Mission & Pipeline**

## **1\. Purpose**

This document governs the "One-Way Compilation Pipeline." It ensures that the transition from a visual Design State (Draft) to a production-ready Compiled Artifact (Snapshot) is immutable and event-driven.

## **2\. Architecture & Data Consumption**

This module is the primary consumer of the **System State** and the **Sync Logic**.

* **Context Subscription:** Subscribes to /artifacts/${appId}/public/data/globalSession to monitor the buildStatus and activeVersion.  
* **Data Structure:**  
  {  
    "pipeline": {  
      "status": "idle | compiling | error | success",  
      "triggeredAt": "ISO-Timestamp",  
      "abortedAt": "ISO-Timestamp?",  
      "publishedAt": "ISO-Timestamp?",  
      "draftId": "current-firestore-doc-id",  
      "compiledId": "last-compiled-doc-id"  
    }  
  }

## **3\. Events & Handlers**

| Event Type | Payload Schema | Handler Description |
| :---- | :---- | :---- |
| PIPELINE\_TRIGGER\_BUILD | { draftId: string } | Triggers the server-side Cloud Function to begin the JSON-to-CSS/JS compilation process. |
| PIPELINE\_PUBLISH\_VERSION | { tag: string, notes: string } | Snapshots the current Compiled Artifact into a permanent, versioned collection. |
| PIPELINE\_ABORT\_BUILD | { reason: string } | Sends an interrupt signal to the build worker and resets the UI status to idle. |

## **4\. Architectural Rules**

1. **Immutability:** Once a build is triggered, the draftId cannot be changed until the status returns to idle.  
2. **Draft Lock:** Triggering a build acquires a draftLock in globalSession; edits must be rejected while locked.  
3. **Shadowing:** The handler must ensure the Compiled Artifact always references the exact draftId it was built from to prevent logic/style mismatches.
